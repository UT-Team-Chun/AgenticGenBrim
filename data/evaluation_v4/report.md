# 評価結果レポート (evaluation_v4)

## 1. 概要

本レポートは、鋼プレートガーダー橋 BrIM 生成エージェントの性能評価結果をまとめたものです。

### 評価条件

- **評価ケース数**: 192件（32条件 × RAG有無 × 3試行）
- **橋長 (L)**: 20m, 25m, 30m, 35m, 40m, 45m, 50m, 55m, 60m, 65m, 70m
- **幅員 (B)**: 8m, 10m, 12m, 16m, 20m, 24m
- **RAG 有無**: true / false
- **各条件の試行数**: 3回
- **使用モデル**: gpt-5.1
- **最大修正回数**: 5回

**用語定義**:

> **修正回数**: Designer生成→Judge照査で不合格となった際にPatchPlanを適用して再生成する回数を指す。初回合格は修正回数0。最大修正回数5は、修正ループを最大5回まで実行することを意味する。

> **平均修正回数**: 収束ケースのみを母数として算出。不収束ケースは除外。初回合格（修正回数0）も母数に含むため、初回合格率が高い区分では平均値が1未満になりうる（例: L=65m RAGあり → 平均0.57）。

> **収束率**: 最大修正回数（5回）以内に全5チェック項目を合格した試行の割合。

**統制条件（RAGあり/なし共通）**:

> - LLMモデル: gpt-5.1（パラメータはOpenAI APIデフォルト）
> - Designerプロンプト: 同一テンプレート（`src/bridge_agentic_generate/designer/prompts.py`）
> - RAGなし時: プロンプトのRAGコンテキスト欄が空文字列になるのみで、テンプレート構造は同一
> - Judge照査ロジック: 同一（決定論的計算）
> - 修正ループ: 同一のPatchPlan生成ロジック（LLMによる修正案生成）・最大修正回数
>
> RAGあり/なしで異なるのは、Designer生成時にRAG検索結果（道路橋示方書等の条文チャンク）をコンテキストとして付与するか否かのみである。

#### 32条件の L×B 組み合わせ

| L＼B | 8m | 10m | 12m | 16m | 20m | 24m |
|------|----|-----|-----|-----|-----|-----|
| **20m** | ✓ | ✓ | | | | |
| **25m** | ✓ | ✓ | ✓ | | | |
| **30m** | ✓ | ✓ | ✓ | | | |
| **35m** | ✓ | ✓ | | ✓ | | |
| **40m** | ✓ | ✓ | | | ✓ | |
| **45m** | ✓ | ✓ | | | ✓ | |
| **50m** | | ✓ | | ✓ | | ✓ |
| **55m** | | ✓ | | ✓ | | ✓ |
| **60m** | | ✓ | | ✓ | | ✓ |
| **65m** | | | ✓ | ✓ | | ✓ |
| **70m** | | | ✓ | ✓ | | ✓ |

短スパン（L=20-45m）は狭幅員（B=8-20m）、長スパン（L=50-70m）は広幅員（B=10-24m）を中心に、実務的に想定される組み合わせを選定。

### 評価項目

| チェック項目 | 内容 |
|-------------|------|
| deck | 床版厚チェック（必要厚 ≤ 実厚） |
| bend | 曲げ応力チェック（σ ≤ σ_allow） |
| shear | せん断応力チェック（τ ≤ τ_allow） |
| deflection | たわみチェック（δ ≤ δ_allow） |
| web_slenderness | 腹板幅厚比チェック |

---

## 2. 全体サマリー

| 指標 | 全体 | RAG あり | RAG なし |
|------|------|----------|----------|
| 総試行数 | 192 | 96 | 96 |
| **初回合格率** | 18.8% | **37.5%** | 0.0% |
| **収束率** | 80.2% | **85.4%** | 75.0% |
| **平均修正回数** | 1.93 | **1.40** | 2.53 |

### 主要な知見

1. **RAG の効果**
   - RAG ありの場合、初回合格率が **37.5%**（RAG なしは **0.0%**）
   - 収束率が **85.4%**（RAG なしは **75.0%**）
   - 平均修正回数が改善（2.53 → 1.40）

2. **本評価条件では RAG なしの初回合格は観測されなかった**
   - RAG なしの初回合格率は **0.0%**（96件全て初回不合格）。ただし各条件の試行数が3回であるため、低頻度の初回合格が存在する可能性は排除できない
   - RAG が初回設計品質に大きな影響を与えていることが示唆される

---

## 3. チェック項目別の初回合格率

| チェック項目 | 全体 | RAG あり | RAG なし | RAG効果 |
|-------------|------|----------|----------|---------|
| **shear** | 100.0% | 100.0% | 100.0% | ± 0.0% |
| **web_slenderness** | 100.0% | 100.0% | 100.0% | ± 0.0% |
| **deck** | 83.3% | 100.0% | 66.7% | **+33.3%** |
| **bend** | 30.2% | 46.9% | 13.5% | **+33.4%** |
| **deflection** | 28.6% | 51.0% | 6.2% | **+44.8%** |

### 分析

- **shear（せん断）** / **web_slenderness（腹板幅厚比）**: 全ケースで初回合格（100%）。shear は全条件で合格しており、本評価の橋長・幅員範囲（L=20–70m, B=8–24m）ではせん断応力が支配的照査項目とならなかった。これは単純桁の場合、曲げ・たわみが先に支配的となる傾向と整合する。なお、shear / web_slenderness は初回では全ケース合格だが、修正ループ中にウェブ高増加の副作用として web_slenderness が不合格に転じうる（§6参照）
- **deck（床版厚）**: RAG により 33.3% 改善。RAG ありでは **100%** が初回合格

  **deck 100% の根拠データ**:

  RAG ログを確認すると、床版厚関連の条文（道路橋示方書 p.117: 最小全厚テーブル `d0 = 30L + 110`）がランク16-17（スコア0.70-0.71）で安定して検索されている。代表ケース（L=20m, B=8m）での具体的比較:

  | | RAG あり | RAG なし |
  |--|----------|----------|
  | deck 厚 | 180mm | 200mm |
  | 式値 | 30×2.0+110 = 170mm | （式根拠なし） |
  | 根拠 | 式値+10mmマージン | 丸め数値 |

  RAG ありでは式に準拠した厚さを生成する傾向があり、96件中96件で deck 初回合格（100%）を達成している。RAG なしでは条文を参照できず、過小な床版厚を設定するケースが 32件（33.3%）発生した。

- **deflection（たわみ）**: 最も RAG の効果が顕著（+44.8%）。RAG なしでは 6.2% と低い

  **deflection 改善の構造的メカニズム**:

  本システムのたわみ照査は道路橋示方書に基づき活荷重のみで実施（`services.py` L564-571）しており、主桁の断面二次モーメント I が活荷重たわみを制御する決定的パラメータとなる。

  RAG ログでは、桁高/支間比（h/L）に関するガイダンス「h/L ≒ 1/15〜1/20 が適当」（式(7.364)）がランク2付近で検索されている。これが初回設計のウェブ高選択に直接影響を与えていることが、RAG reasoning の記述（「桁高目安 h ≒ L/15〜L/20 を採用」）から確認できる。初回設計（iter0）のパラメータを32条件それぞれで RAG あり/なし各3試行の平均を取り、対応ありで比較した結果:

  | パラメータ | RAG あり | RAG なし | 差 | p値 |
  |-----------|---------|---------|------|------|
  | ウェブ高 | 2,408mm | 2,119mm | **+13.6%** | 1.4×10⁻⁶ |
  | 上フランジ幅 | 542mm | 443mm | +22.5% | 7.5×10⁻⁶ |
  | 下フランジ幅 | 637mm | 531mm | +20.0% | 1.7×10⁻⁵ |
  | 桁本数 | 4.0本 | 4.0本 | −0.9% | — |

  ※ Wilcoxon signed-rank 検定（対応あり・両側, n=32条件ペア）。各条件の3試行平均を1データ点とした。データは修正ループ前の初回設計（`design_logs/*/..._iter0.json`）を使用。

  ウェブ高は **30/32条件（94%）** で RAG ありが上回り、RAG が直接提供する h/L ルールの効果が明確である。フランジ幅も有意に大きいが、**RAG ヒットにフランジ幅の具体的な数値規定は含まれていない**。フランジ/ウェブ高の比率を確認すると:

  | | RAG あり | RAG なし | p値 |
  |--|---------|---------|------|
  | 下フランジ幅/ウェブ高 比率 | 0.273 | 0.261 | 0.15（n.s.） |

  比率に有意差はなく（19/32条件でRAGありが上回るのみ）、ウェブ高差分とフランジ幅差分の相関も弱い（r=0.14）。すなわち、LLM はRAGの有無に関わらず概ね一定の比率でフランジを設計しており、**フランジ幅の差はウェブ高増加に伴う間接的な結果**と解釈される。

  因果チェーンをまとめると:

  1. RAG が h/L ≒ 1/15〜1/20 を提供 → **ウェブ高が13.6%増加**（直接効果）
  2. LLM がフランジ/ウェブ比を概ね一定（~0.27）に保つ → **フランジ幅も連動して増加**（間接効果）
  3. ウェブ高・フランジ幅の両方が大きくなることで **断面二次モーメント I が増加** → たわみ改善

  deflection 初回合格/不合格で分けた初回設計の断面中央値:

  | 群 | n | 上フランジ幅 | 下フランジ幅 | ウェブ高 |
  |----|---|------------|------------|---------|
  | RAGあり・defl合格 | 49 | 600mm | 750mm | 2,800mm |
  | RAGあり・defl不合格 | 47 | 400mm | 500mm | 1,900mm |
  | RAGなし・defl合格 | 6 | 450mm | 550mm | 2,450mm |
  | RAGなし・defl不合格 | 90 | 400mm | 500mm | 2,000mm |

  合格群と不合格群の間にはウェブ高で800-900mmの差があり、I への寄与が大きい。RAG の h/L ルールがウェブ高を適切に設定させることが、たわみ初回合格率の差（51.0% vs 6.2%）の主因と考えられる。

- **bend（曲げ）**: RAG により 33.4% 改善。最も収束が難しい項目

### 初回不合格ケースの不合格項目内訳

#### RAG あり: 不合格パターン

RAG あり・初回不合格（60件）の不合格パターン:

| パターン | 件数 | 割合 |
|----------|------|------|
| bend + deflection | 38 | 63.3% |
| bend のみ | 13 | 21.7% |
| deflection のみ | 9 | 15.0% |

#### RAG なし: 不合格パターン

RAG なし・初回不合格（96件）の不合格パターン:

| パターン | 件数 | 割合 |
|----------|------|------|
| bend + deflection | 50 | 52.1% |
| deck + bend + deflection | 28 | 29.2% |
| deflection のみ | 11 | 11.5% |
| bend のみ | 3 | 3.1% |
| deck + bend | 2 | 2.1% |
| その他 | 2 | 2.1% |

### 不合格パターンの考察

1. **RAG ありでは deck が完全解消**: RAG なしでは 29.2% のケースで deck が不合格に含まれるが、RAG ありでは deck 不合格が **0件**
2. **残る課題は bend と deflection**: RAG ありでも 63.3% が bend+deflection の同時不合格
3. **残る課題は bend と deflection に集約**: shear と web_slenderness は全ケースで合格しており、改善対象は bend と deflection

---

## 4. 条件別詳細

### 4.1 橋長別の傾向

| 橋長 | 幅員 | RAG | 初回合格率 | 平均修正回数 | 収束率 |
|------|------|-----|-----------|----------|--------|
| L=20m | 8, 10 | あり | 0.0% | 1.83 | 100% |
| L=20m | 8, 10 | なし | 0.0% | 1.83 | 100% |
| L=25m | 8, 10, 12 | あり | 22.2% | 1.56 | 100% |
| L=25m | 8, 10, 12 | なし | 0.0% | 2.11 | 100% |
| L=30m | 8, 10, 12 | あり | 33.3% | 1.33 | 100% |
| L=30m | 8, 10, 12 | なし | 0.0% | 1.56 | 100% |
| L=35m | 8, 10, 16 | あり | 22.2% | 1.33 | 100% |
| L=35m | 8, 10, 16 | なし | 0.0% | 1.56 | 100% |
| L=40m | 8, 10, 20 | あり | 33.3% | 1.57 | 78% |
| L=40m | 8, 10, 20 | なし | 0.0% | 2.56 | 100% |
| L=45m | 8, 10, 20 | あり | 66.7% | 1.25 | 89% |
| L=45m | 8, 10, 20 | なし | 0.0% | 2.43 | 78% |
| L=50m | 10, 16, 24 | あり | 44.4% | 1.57 | 78% |
| L=50m | 10, 16, 24 | なし | 0.0% | 3.14 | 78% |
| L=55m | 10, 16, 24 | あり | 44.4% | 2.00 | 100% |
| L=55m | 10, 16, 24 | なし | 0.0% | 3.00 | 67% |
| L=60m | 10, 16, 24 | あり | 33.3% | 1.50 | 67% |
| L=60m | 10, 16, 24 | なし | 0.0% | 4.20 | 56% |
| L=65m | 12, 16, 24 | あり | 55.6% | 0.57 | 78% |
| L=65m | 12, 16, 24 | なし | 0.0% | 5.00 | 11% |
| L=70m | 12, 16, 24 | あり | 44.4% | 0.60 | 56% |
| L=70m | 12, 16, 24 | なし | 0.0% | 4.50 | 44% |

**傾向**:
- RAG ありでは L=45m で最高の初回合格率 **66.7%** を記録
- RAG ありでは長スパン（L=65-70m）でも初回合格率 44-56% を維持
- RAG なしでは全橋長で初回合格率 **0%**
- 橋長が長くなるほど収束率が低下（特に RAG なし: L=65m で 11%）
- L=65m で RAG の収束率効果が最も顕著（78% vs 11%）

### 4.2 幅員別の傾向

| 幅員 | 橋長 | RAG | 初回合格率 | 平均修正回数 | 収束率 |
|------|------|-----|-----------|----------|--------|
| B=8m | 20, 25, 30, 35, 40, 45 | あり | 66.7% | 0.56 | 100% |
| B=8m | 20, 25, 30, 35, 40, 45 | なし | 0.0% | 1.50 | 100% |
| B=10m | 20, 25, 30, 35, 40, 45, 50, 55, 60 | あり | 40.7% | 1.15 | 100% |
| B=10m | 20, 25, 30, 35, 40, 45, 50, 55, 60 | なし | 0.0% | 2.33 | 100% |
| B=12m | 25, 30, 65, 70 | あり | 41.7% | 1.25 | 100% |
| B=12m | 25, 30, 65, 70 | なし | 0.0% | 3.00 | 75% |
| B=16m | 35, 50, 55, 60, 65, 70 | あり | 38.9% | 1.76 | 94% |
| B=16m | 35, 50, 55, 60, 65, 70 | なし | 0.0% | 3.38 | 72% |
| B=20m | 40, 45 | あり | 0.0% | 4.67 | 50% |
| B=20m | 40, 45 | なし | 0.0% | 4.00 | 67% |
| B=24m | 50, 55, 60, 65, 70 | あり | 6.7% | 3.00 | 33% |
| B=24m | 50, 55, 60, 65, 70 | なし | 0.0% | 5.00 | 7% |

**傾向**:
- B=8m で RAG ありの初回合格率 **66.7%** と最高
- B=8-16m では RAG ありの収束率 94-100%
- B=20-24m は極端に難易度が高い
- B=24m, RAG なし で収束率 **7%**（15件中1件のみ合格）
- B=20m では RAG なしの方が収束率が高い（67% vs 50%）という逆転現象が発生

---

## 5. 条件別詳細統計

### L30_B8 (橋長30m, 幅員8m)

| 指標 | RAG あり | RAG なし |
|------|----------|----------|
| 初回合格率 | **100%** | 0% |
| 収束率 | 100% | 100% |
| 平均修正回数 | 0.00 | 1.00 |
| 初回最大利用率(平均) | 0.932 | 1.108 |

**チェック別初回合格率**:
| チェック | RAG あり | RAG なし |
|----------|----------|----------|
| deck | 100% | 100% |
| bend | 100% | 100% |
| shear | 100% | 100% |
| deflection | 100% | 0% |
| web_slenderness | 100% | 100% |

---

### L45_B8 (橋長45m, 幅員8m)

| 指標 | RAG あり | RAG なし |
|------|----------|----------|
| 初回合格率 | **100%** | 0% |
| 収束率 | 100% | 100% |
| 平均修正回数 | 0.00 | 1.33 |
| 初回最大利用率(平均) | 0.955 | 1.084 |

**チェック別初回合格率**:
| チェック | RAG あり | RAG なし |
|----------|----------|----------|
| deck | 100% | 100% |
| bend | 100% | 0% |
| shear | 100% | 100% |
| deflection | 100% | 67% |
| web_slenderness | 100% | 100% |

---

### L50_B10 (橋長50m, 幅員10m)

| 指標 | RAG あり | RAG なし |
|------|----------|----------|
| 初回合格率 | **100%** | 0% |
| 収束率 | 100% | 100% |
| 平均修正回数 | 0.00 | 2.67 |
| 初回最大利用率(平均) | 0.936 | 1.237 |

**チェック別初回合格率**:
| チェック | RAG あり | RAG なし |
|----------|----------|----------|
| deck | 100% | 100% |
| bend | 100% | 0% |
| shear | 100% | 100% |
| deflection | 100% | 0% |
| web_slenderness | 100% | 100% |

---

### L65_B16 (橋長65m, 幅員16m)

| 指標 | RAG あり | RAG なし |
|------|----------|----------|
| 初回合格率 | **100%** | 0% |
| 収束率 | 100% | 0% |
| 平均修正回数 | 0.00 | - |
| 初回最大利用率(平均) | 0.955 | 2.042 |

**チェック別初回合格率**:
| チェック | RAG あり | RAG なし |
|----------|----------|----------|
| deck | 100% | 33% |
| bend | 100% | 0% |
| shear | 100% | 100% |
| deflection | 100% | 0% |
| web_slenderness | 100% | 100% |

---

### L70_B12 (橋長70m, 幅員12m)

| 指標 | RAG あり | RAG なし |
|------|----------|----------|
| 初回合格率 | **100%** | 0% |
| 収束率 | 100% | 67% |
| 平均修正回数 | 0.00 | 4.50 |
| 初回最大利用率(平均) | 0.969 | 1.414 |

**チェック別初回合格率**:
| チェック | RAG あり | RAG なし |
|----------|----------|----------|
| deck | 100% | 100% |
| bend | 100% | 0% |
| shear | 100% | 100% |
| deflection | 100% | 0% |
| web_slenderness | 100% | 100% |

---

### L60_B24 (橋長60m, 幅員24m)

| 指標 | RAG あり | RAG なし |
|------|----------|----------|
| 初回合格率 | 0% | 0% |
| 収束率 | 0% | 0% |
| 平均修正回数 | - | - |
| 初回最大利用率(平均) | 1.506 | 2.075 |

**チェック別初回合格率**:
| チェック | RAG あり | RAG なし |
|----------|----------|----------|
| deck | 100% | 0% |
| bend | 0% | 0% |
| shear | 100% | 100% |
| deflection | 33% | 0% |
| web_slenderness | 100% | 100% |

---

### L70_B24 (橋長70m, 幅員24m)

| 指標 | RAG あり | RAG なし |
|------|----------|----------|
| 初回合格率 | 0% | 0% |
| 収束率 | 0% | 0% |
| 平均修正回数 | - | - |
| 初回最大利用率(平均) | 2.059 | 1.976 |

**チェック別初回合格率**:
| チェック | RAG あり | RAG なし |
|----------|----------|----------|
| deck | 100% | 33% |
| bend | 0% | 0% |
| shear | 100% | 100% |
| deflection | 33% | 0% |
| web_slenderness | 100% | 100% |

---

## 6. 収束しなかったケース

**収束失敗ケース数**: 38件（全体の 19.8%）

- RAG あり: 14件（14.6%）
- RAG なし: 24件（25.0%）

| ケースID | 最終最大利用率 | 不合格項目 |
|----------|---------------|-----------|
| L40_B20_rag_true_trial_1 | 1.014 | bend, web_slenderness |
| L40_B20_rag_true_trial_2 | 1.141 | bend, web_slenderness |
| L45_B20_rag_false_trial_1 | 1.128 | bend, web_slenderness |
| L45_B20_rag_false_trial_3 | 1.084 | bend |
| L45_B20_rag_true_trial_1 | 1.003 | bend |
| L50_B24_rag_false_trial_1 | 1.127 | bend, web_slenderness |
| L50_B24_rag_false_trial_2 | 1.190 | bend |
| L50_B24_rag_true_trial_1 | 1.016 | web_slenderness |
| L50_B24_rag_true_trial_2 | 1.016 | web_slenderness |
| L55_B24_rag_false_trial_1 | 1.093 | bend |
| L55_B24_rag_false_trial_2 | 1.027 | bend |
| L55_B24_rag_false_trial_3 | 1.095 | bend, web_slenderness |
| L60_B16_rag_false_trial_2 | 1.115 | bend, web_slenderness |
| L60_B24_rag_false_trial_1 | 1.171 | bend |
| L60_B24_rag_false_trial_2 | 1.129 | bend, web_slenderness |
| L60_B24_rag_false_trial_3 | 1.047 | bend |
| L60_B24_rag_true_trial_1 | 1.092 | bend |
| L60_B24_rag_true_trial_2 | 1.026 | bend |
| L60_B24_rag_true_trial_3 | 1.023 | bend |
| L65_B12_rag_false_trial_2 | 1.021 | bend |
| L65_B12_rag_false_trial_3 | 1.012 | bend |
| L65_B16_rag_false_trial_1 | 1.062 | bend |
| L65_B16_rag_false_trial_2 | 1.063 | bend |
| L65_B16_rag_false_trial_3 | 1.010 | bend |
| L65_B24_rag_false_trial_1 | 1.164 | bend, web_slenderness |
| L65_B24_rag_false_trial_2 | 1.131 | bend, web_slenderness |
| L65_B24_rag_false_trial_3 | 1.180 | bend, web_slenderness |
| L65_B24_rag_true_trial_1 | 1.088 | bend, web_slenderness |
| L65_B24_rag_true_trial_3 | 1.047 | bend |
| L70_B12_rag_false_trial_1 | 1.039 | bend |
| L70_B16_rag_false_trial_3 | 1.093 | bend, web_slenderness |
| L70_B16_rag_true_trial_3 | 1.020 | bend |
| L70_B24_rag_false_trial_1 | 1.237 | bend |
| L70_B24_rag_false_trial_2 | 1.292 | bend, web_slenderness |
| L70_B24_rag_false_trial_3 | 1.047 | bend, web_slenderness |
| L70_B24_rag_true_trial_1 | 1.010 | web_slenderness |
| L70_B24_rag_true_trial_2 | 1.202 | bend, web_slenderness |
| L70_B24_rag_true_trial_3 | 1.184 | bend |

**不合格項目の内訳**:
- **bend のみ**: 22件（57.9%）
- **bend + web_slenderness**: 13件（34.2%）
- **web_slenderness のみ**: 3件（7.9%）
- deck, shear, deflection での不収束は **0件**

**分析**:
- 収束失敗は主に **B≥20m** の広幅員条件で集中
- B=24m は RAG ありでも 10/15件、RAG なしでは 14/15件が不収束
- B=20m は 3/6件が不収束
- 不収束の原因は **bend（曲げ）が支配的**（38件中35件に含まれる）
- web_slenderness は広幅員 (B=20-24m) で bend と併発する傾向。web_slenderness の不合格は初回設計では発生せず（§3参照: 初回合格率100%）、修正ループにおけるウェブ高増加（bend/deflection対策）に伴い必要最小腹板厚（= web_height / 130 for SM490）が増加した結果として二次的に発生するものである。すなわち、修正ループが bend を解消するためにウェブ高を増やすと、腹板幅厚比の制約が厳しくなり、既存の腹板厚では不合格に転じる
- 最終利用率が 1.0-1.1 の範囲のケースが多く（38件中24件）、追加修正で収束する可能性がある
- L65_B16_rag_false は 3trial 全て不収束だが、利用率は 1.010-1.063 と非常に惜しい

---

## 7. 結論と考察

### RAG の効果

1. **初回合格率への強い効果**
   - RAG あり: 37.5% / RAG なし: 0.0%（+37.5%）
   - RAG なしでは全 96 件で初回合格が達成されなかった
   - RAG は初回設計品質に強い影響を与えていることが示唆される

2. **チェック項目別の効果**
   - **deck**: RAG ありで **100%** 初回合格（RAG なし 66.7%）。道路橋示方書の床版厚規定の完全な参照
   - **deflection**: 最も効果顕著（+44.8%）。たわみ制限値の適切な設計
   - **bend**: 改善（+33.4%）。曲げ断面の適切なサイジング
   - **shear / web_slenderness**: 初回では両条件とも100%合格。shear については本評価条件ではせん断利用率が低く、設計を支配する項目とはならなかった。web_slenderness は修正ループ中に二次的に不合格となるケースがある（§6参照）

3. **収束率の改善**
   - RAG あり: 85.4% / RAG なし: 75.0%（+10.4%）
   - 特に長スパン（L=65m）で顕著: 78% vs 11%

### 残る課題

1. **広幅員（B≥20m）への対応**
   - B=20m: 収束率 50-67%
   - B=24m: 収束率 7-33%
   - 広幅員での主桁配置・断面設計が根本的な課題

   **詳細分析: B=24m で Designer が桁本数を過少に選択する問題**

   Designer プロンプト（`src/bridge_agentic_generate/designer/prompts.py`）では主桁本数の候補を `{3,4,5,6}` と指定しているが、
   B=24m の全30件で実際に選択された桁本数の分布は以下の通り:

   | 桁本数 | 件数 | 割合 | 収束率 |
   |--------|------|------|--------|
   | 5本    | 19件 | 63%  | 3/19 = **16%** |
   | 6本    | 10件 | 33%  | 2/10 = **20%** |
   | 7本    | 1件  | 3%   | 1/1 = **100%** |

   5本桁（間隔 5250-5500mm）の収束率が 16% と極めて低く、7本桁（間隔 3600mm）の唯一のケースは合格している。
   6本桁でも収束率 20% にとどまり、B=24m では6本でも不十分な場合が多い。

   なお、プロンプトでは候補を {3,4,5,6} と指定しているが、出力スキーマ上は整数値の上限制約を設けていないため、LLM がプロンプト指示を逸脱して7本を出力した場合もバリデーションエラーとならず受理される仕様である。L55\_B24\_rag\_true\_trial\_1 の7本桁は、この逸脱によるものである。本ケースが唯一の収束例であったことは、B=24m では6本以上の桁本数が構造的に必要であることを示唆している。

   各ケースの桁本数・間隔・合否の一覧（参照: `designs/L*_B24_*.json`, `results/L*_B24_*.json`）:

   | ケース | 桁本数 | 間隔(mm) | 収束 | max_util |
   |--------|--------|----------|------|----------|
   | L50_B24_rag_false_trial_1 | 5 | 5500 | x | 1.127 |
   | L50_B24_rag_false_trial_2 | 6 | 4400 | x | 1.190 |
   | L50_B24_rag_false_trial_3 | 5 | 5500 | o | 0.982 |
   | L50_B24_rag_true_trial_1 | 5 | 5500 | x | 1.016 |
   | L50_B24_rag_true_trial_2 | 5 | 5400 | x | 1.016 |
   | L50_B24_rag_true_trial_3 | 5 | 5250 | o | 0.995 |
   | L55_B24_rag_false_trial_1 | 5 | 5500 | x | 1.093 |
   | L55_B24_rag_false_trial_2 | 5 | 5500 | x | 1.027 |
   | L55_B24_rag_false_trial_3 | 5 | 5500 | x | 1.095 |
   | L55_B24_rag_true_trial_1 | **7** | **3600** | **o** | **0.991** |
   | L55_B24_rag_true_trial_2 | 6 | 4320 | o | 0.994 |
   | L55_B24_rag_true_trial_3 | 5 | 5500 | o | 0.982 |
   | L60_B24_rag_false_trial_1 | 6 | 4400 | x | 1.171 |
   | L60_B24_rag_false_trial_2 | 5 | 5250 | x | 1.129 |
   | L60_B24_rag_false_trial_3 | 5 | 5500 | x | 1.047 |
   | L60_B24_rag_true_trial_1 | 5 | 5500 | x | 1.092 |
   | L60_B24_rag_true_trial_2 | 6 | 4400 | x | 1.026 |
   | L60_B24_rag_true_trial_3 | 5 | 5500 | x | 1.023 |
   | L65_B24_rag_false_trial_1 | 5 | 5500 | x | 1.164 |
   | L65_B24_rag_false_trial_2 | 6 | 4400 | x | 1.131 |
   | L65_B24_rag_false_trial_3 | 5 | 5500 | x | 1.180 |
   | L65_B24_rag_true_trial_1 | 5 | 5500 | x | 1.088 |
   | L65_B24_rag_true_trial_2 | 6 | 4320 | o | 0.977 |
   | L65_B24_rag_true_trial_3 | 6 | 4400 | x | 1.047 |
   | L70_B24_rag_false_trial_1 | 5 | 5500 | x | 1.237 |
   | L70_B24_rag_false_trial_2 | 6 | 4200 | x | 1.292 |
   | L70_B24_rag_false_trial_3 | 6 | 4400 | x | 1.047 |
   | L70_B24_rag_true_trial_1 | 5 | 5500 | x | 1.010 |
   | L70_B24_rag_true_trial_2 | 6 | 4320 | x | 1.202 |
   | L70_B24_rag_true_trial_3 | 5 | 5400 | x | 1.184 |

   **LLM が5本桁を選ぶ理由（RAG ログの reasoning より）:**

   - 「5本 → 間隔 5500mm は妥当な範囲（3000-6000mm）」と判定
   - 「6本にすると鋼重・製作コストが増加する」という経済性を優先
   - 「幅員 24m クラスでは5主桁程度が標準的」という実務感覚

   しかし LLM は曲げ照査の定量的見通しを持たないまま桁本数を決めているため、
   経済性・標準慣行を優先した結果、構造的に不足する配置を選択してしまっている。

   **構造的な問題:**
   - Judge の修正ループは断面寸法（ウェブ高さ・板厚・フランジ厚）の増減のみ可能
   - 桁本数・桁間隔の変更は Designer の初回選択に依存しており、Judge では修正不可
   - 今回はそこまで大きな変更をしないよう制限していたが、それが裏目に出てしまった
   - 5本桁 × 5500mm 間隔では中間桁への荷重集中が激しく、断面増加だけでは収束困難

   **参照データ:**
   - 設計 JSON: `data/evaluation_v4/designs/L*_B24_*.json`
   - 照査結果: `data/evaluation_v4/results/L*_B24_*.json`
   - RAG ログ（reasoning）: `data/evaluation_v4/raglogs/L*_B24_*.json`
   - Designer プロンプト: `src/bridge_agentic_generate/designer/prompts.py` L99

2. **bend と deflection の同時不合格**
   - RAG ありでも初回不合格の 63.3% が bend+deflection の組み合わせ
   - 修正（主にウェブ高増加）はたわみに強く効き曲げに弱く効くため、たわみは早期に解消するが曲げの収束に多くの修正回数を要する
   - 不収束ケースの大半は deflection 解消済みで bend だけが 1.0 を割れずに終了するパターン
   - 根拠データ: `data/evaluation_v4/results/L*_B*_*.json`（per_check_first_pass, first_utilization）、`data/generated_judge_json/*_iter*_judge.json`（修正回ごとの utilization 推移）

3. **収束率の改善余地**
   - 不収束ケースの 63%（24/38件）が最終利用率 1.0-1.1 の範囲
   - 最大修正回数の引き上げ（5→7-10）で改善の余地あり

### 今後の改善案

1. **広幅員対応の強化**: B=20m 以上での多主桁配置の最適化ロジック
2. **bend 収束の加速**: たわみ解消後も bend が残るケースに対し、フランジ幅・板厚増加など曲げに直接効く修正を優先する戦略の導入
3. **最大修正回数の引き上げ**: 惜しいケースの救済
4. **RAG コンテンツの拡充**: 広幅員・大スパン向けの設計知識の追加

---

## 付録: 評価データファイル

- `designs/`: Designer が生成した BridgeDesign JSON
- `judges/`: Judge による照査結果 JSON
- `results/`: 試行ごとの評価結果サマリー
- `raglogs/`: RAG 検索ログ
- `design_logs/`: 修正回ごとの設計ログ
- `summary.json`: 全体集計結果

---

## 手法自体の課題

### 1. 評価設計上の課題

- **試行数 3 回は統計的に不十分**
    - 各条件で n=3 のため、33% と 67% の差が偶然か有意かの判断が困難
- **収束判定**
    - 最終利用率 1.0-1.1 で停止したケースが多く、追加修正で収束する可能性

### 2. RAG の課題

- **RAG ありでも初回合格率 37.5%**
    - 62.5% は RAG があっても初回で適切な設計を出せていない
    - bend と deflection の初回合格率はまだ 47-51% に留まる

### 3. LLM の限界

- **数値推定の本質的困難**
    - 構造計算は「正解を計算で求める」問題だが、LLM は「それらしい値を生成する」ためミスマッチ
- **広幅員の設計**
    - B=20-24m での設計は学習データに少ない可能性
- **修正ループ依存**
    - 結局「LLM が出力 → 決定論計算で修正」というパターンに依存

### 4. 実用性の課題

- **計算コスト**
    - 最大 5 回の LLM 呼び出しでも収束しないケースが 19.8% 存在
- **再現性**
    - 同じ条件でも試行によって結果が異なる（確率的挙動）
- **スケーラビリティ**
    - 評価対象が「鋼プレートガーダー橋（RC 床版）」の断面モデルに限定
- **実務適用性**
    - 5 項目のチェックのみで、実務で必要な照査項目（疲労、座屈、連結部等）が未対応
