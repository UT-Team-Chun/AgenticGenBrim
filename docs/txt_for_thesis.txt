================================================================================
鋼プレートガーダー橋 BrIM 生成エージェントシステム
― 論文用原稿 ―
================================================================================

作成日: 2026年1月26日


================================================================================
目次
================================================================================

1. 要旨（Abstract）

2. はじめに（Introduction）

3. 背景および関連研究（Background / Related Work）

4. 提案システム（Proposed System）
   4.1 システム概要
   4.2 RAG（検索拡張生成）サブシステム
   4.3 Designer（設計生成）サブシステム
   4.4 Judge（照査・修正提案）サブシステム
   4.5 IFC 変換サブシステム

5. 評価実験（Evaluation）
   5.1 実験設定
   5.2 評価指標
   5.3 結果

6. 考察（Discussion）

7. おわりに（Conclusion）

付録 A: 主要 Pydantic モデル一覧
付録 B: 設計ルールカテゴリ
付録 C: 対応 LLM モデル
付録 D: 参考文献（RAG 対象 PDF）


================================================================================
1. 要旨（Abstract）
================================================================================

（後で記載）


================================================================================
2. はじめに（Introduction）
================================================================================

（後で記載）


================================================================================
3. 背景および関連研究（Background / Related Work）
================================================================================

（後で記載）


================================================================================
4. 提案システム（Proposed System）
================================================================================

--------------------------------------------------------------------------------
4.1 システム概要
--------------------------------------------------------------------------------

【本システムでできること】

  [1] 最小限の入力から断面設計を自動生成
      - 入力：橋長 L [m] と 幅員 B [m] の 2 パラメータのみ
      - 出力：主桁本数、桁高、板厚、床版厚など全断面寸法を自動決定

  [2] 設計根拠の明示（RAG による文献参照）
      - 道路橋示方書、鋼橋設計の基本（教科書）から関連条文を自動検索
      - どの文献のどのページを根拠にしたかをログに記録
      - 設計者が「なぜその寸法になったか」を確認可能

  [3] 設計ルールの構造化抽出
      - 「桁高 ≒ L/20」「床版厚 d = 30L + 110」などの数式を明示
      - 各ルールに根拠（文献の rank）または「仮定」を付与
      - 将来の設計ルールDB構築の基盤

  [4] 決定論的照査と自動修正ループ（Judge）
      - 曲げ・せん断・たわみ・床版厚・腹板幅厚比・横桁配置の 6 項目を照査
      - 不合格時は LLM が修正提案（PatchPlan）を生成
      - 合格するまで自動で設計修正を繰り返す（最大 5 イテレーション）

  [5] IFC 形式での 3D モデル出力
      - BIM/CIM ソフトウェアで表示可能な IFC ファイルを生成
      - 床版、主桁（I形断面）、横桁を 3D モデル化
      - BIMvision、Revit、FreeCAD 等で即座に可視化可能


【技術的な特徴】

  - LLM + RAG による設計知識の活用
    → 道路橋示方書等の PDF から条文を検索し、プロンプトに埋め込み

  - Structured Output による型安全な出力
    → Pydantic スキーマで設計値を厳密に定義、バリデーション済み

  - マルチクエリ RAG
    → 寸法、主桁配置、主桁断面、床版、横桁の 5 観点で並行検索

  - 決定論計算 + LLM ハイブリッド照査
    → 数式による照査計算は決定論的に実行、修正提案のみ LLM が生成

  - 荷重計算の自動化
    → L荷重（p1/p2ルール）に基づく活荷重の内部計算
    → 桁別の死荷重計算（端桁・中間桁で受け持ち幅が異なる）

  - 複数候補方式 PatchPlan 生成
    → LLM が 3 案を生成し、各案を仮適用・評価して最良案を選択

  - Designer-Judge 修正ループ
    → 不合格時は PatchPlan を適用し、合格まで自動で繰り返し

  - 2段階の IFC 変換
    → 設計JSON → Senkei JSON → IFC の変換パイプライン


【対象とする橋梁形式】

  - 橋梁タイプ：鋼プレートガーダー橋（Steel Plate Girder Bridge）
  - 床版形式：RC 床版合成桁（Reinforced Concrete Deck Composite Girder）
  - 構造形式：単純桁または連続桁（MVP では単純桁を想定）

対象とする設計パラメータ：
  - 橋長（L）：30m ～ 100m 程度
  - 幅員（B）：8m ～ 15m 程度


【現時点での制約】

  - 対象は鋼プレートガーダー橋（RC床版）のみ
  - 断面は全長一定（支点部・中央部の変化なし）
  - 照査は概略設計レベル（曲げ・せん断・たわみ・床版厚・腹板幅厚比・横桁配置）
  - 座屈・疲労等の詳細照査は未実装


【全体構成】

システムは以下の 3 層構造で構成される：

┌─────────────────────────────────────────────────────────────────────────────┐
│                          ユーザーインターフェース層                         │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  統合 CLI (src/main.py)                                             │  │
│  │  - generate：設計 JSON 生成                                         │  │
│  │  - run：設計 JSON 生成 → IFC 変換まで一括実行                       │  │
│  │  - run_with_repair：修正ループ付き実行（各イテレーション保存）      │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            コアロジック層                                   │
│  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────────┐  │
│  │  RAG サブシステム  │  │ Designer         │  │ Judge                 │  │
│  │  ・PDF テキスト抽出│  │ サブシステム      │  │ サブシステム          │  │
│  │  ・チャンク化      │  │ ・プロンプト構築 │  │ ・決定論照査計算      │  │
│  │  ・埋め込み生成    │  │ ・LLM 呼び出し   │  │ ・PatchPlan 生成      │  │
│  │  ・ベクトル検索    │  │ ・設計生成       │  │ ・修正ループ制御      │  │
│  └───────────────────┘  └───────────────────┘  └───────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐│
│  │  IFC 変換サブシステム                                                 ││
│  │  ・Simple JSON → Senkei JSON 変換（座標計算）                         ││
│  │  ・Senkei JSON → IFC 変換（ifcopenshell）                             ││
│  └───────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              外部サービス層                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  OpenAI API                                                         │  │
│  │  - Responses API（テキスト生成）                                    │  │
│  │  - Embeddings API（ベクトル埋め込み）                               │  │
│  │  - Structured Output（構造化出力）                                  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘


【データフロー】

設計生成から IFC 出力までの処理フロー：

  ┌──────────────┐
  │ ユーザー入力 │  橋長 L [m], 幅員 B [m]
  └──────┬───────┘
         │
         ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │ Step 1: マルチクエリ RAG 検索                                         │
  │  ・寸法関連クエリ → dimensions_context                                │
  │  ・主桁配置クエリ → girder_layout_context                             │
  │  ・主桁断面クエリ → girder_section_context                            │
  │  ・床版クエリ → deck_context                                          │
  │  ・横桁クエリ → crossbeam_context                                     │
  └──────┬───────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │ Step 2: プロンプト構築                                                │
  │  ・RAG コンテキストを参考文献として埋め込み                           │
  │  ・設計手順と制約条件を明示                                           │
  └──────┬───────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │ Step 3: LLM 呼び出し（Structured Output）                             │
  │  ・DesignerOutput スキーマに従った構造化出力                          │
  │  ・reasoning（設計根拠）+ rules（設計ルール）+ bridge_design（設計値）│
  └──────┬───────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │ Step 4: BridgeDesign JSON 出力                                        │
  │  ・data/generated_simple_bridge_json/ に保存                          │
  │  ・RAG ログを data/generated_bridge_raglog_json/ に保存               │
  └──────┬───────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │ Step 5: Judge 照査（オプション）                                       │
  │  ・決定論的照査（曲げ・せん断・たわみ・床版厚・腹板幅厚比・横桁配置） │
  │  ・合格 → Step 6 へ                                                   │
  │  ・不合格 → PatchPlan 生成 → 修正ループ（Step 5a）                    │
  └──────┬───────────────────────────────────────────────────────────────┘
         │
         │  ┌────────────────────────────────────────────────────────────┐
         │  │ Step 5a: 修正ループ（最大 5 イテレーション）               │
         │  │  ・LLM が PatchPlan（修正提案）を生成                       │
         │  │  ・PatchPlan を BridgeDesign に適用                         │
         │  │  ・依存関係ルール適用（横桁高さ連動など）                   │
         │  │  ・再照査 → 合格するまで繰り返し                           │
         │  └────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │ Step 6: Simple JSON → Senkei JSON 変換                                 │
  │  ・座標計算（主桁配置、格間分割）                                     │
  │  ・IFC 生成用の詳細ジオメトリ情報を追加                               │
  └──────┬───────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │ Step 7: Senkei JSON → IFC 変換                                         │
  │  ・ifcopenshell による IFC 要素生成                                   │
  │  ・床版（Brep）、主桁（SweptSolid）、横桁（SweptSolid）              │
  └──────┬───────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌──────────────┐
  │ IFC ファイル │  data/generated_ifc/*.ifc
  └──────────────┘


【修正ループ（Designer-Judge イテレーション）の詳細フロー】

  初期設計生成（Designer）
       │
       ▼
  ┌─── for iteration in range(max_iterations) ───────────────────────────┐
  │                                                                       │
  │    照査実行（Judge v1）                                               │
  │         │                                                             │
  │         ├── pass_fail == True ──→ 収束・終了                         │
  │         │                                                             │
  │         ▼                                                             │
  │    PatchPlan 生成（LLM）                                              │
  │         │                                                             │
  │         ▼                                                             │
  │    PatchPlan を BridgeDesign に適用                                   │
  │         │                                                             │
  │         ▼                                                             │
  │    依存関係ルール適用（横桁高さ連動など）                             │
  │         │                                                             │
  │         └──────→ 次イテレーションへ                                  │
  │                                                                       │
  └───────────────────────────────────────────────────────────────────────┘
       │
       ▼
  最大イテレーション後も不合格 → converged=False で終了


--------------------------------------------------------------------------------
4.2 RAG（検索拡張生成）サブシステム
--------------------------------------------------------------------------------

【概要】

RAG（Retrieval-Augmented Generation）サブシステムは、道路橋示方書や鋼橋設計の
教科書から関連する条文・解説を検索し、Designer の LLM プロンプトに参考文献として
提供する機能を担う。

主な機能：
  - PDF ドキュメントからのテキスト抽出
  - テキストのチャンク化（分割）
  - OpenAI Embeddings API による埋め込みベクトル生成
  - コサイン類似度に基づくベクトル検索


【対象ドキュメント】

現在 RAG で利用している PDF ドキュメント（FileNamesUsedForRag で定義）：

  1. 鋼橋設計の基本_第一章 概論.pdf
     - 鋼橋の基本概念、設計の考え方

  2. 鋼橋設計の基本_第四章 鋼橋の設計法.pdf
     - 鋼橋の設計手法、荷重・応力計算

  3. 鋼橋設計の基本_第六章 床版.pdf
     - RC 床版の設計、厚さ算定式

  4. 鋼橋設計の基本_第七章 プレートガーダー橋.pdf
     - プレートガーダー橋の構造・設計

  5. 道路橋示方書_鋼橋・鋼部材編.pdf
     - 公式の設計基準、条文


【テキスト抽出機能】

PDF からのテキスト抽出には以下の 3 つの方法を提供している：

  (1) pdfplumber（推奨）
      - src/bridge_agentic_generate/rag/extract_pdfs_with_pdfplumber.py
      - テーブル構造の保持に優れる
      - 出力: data/extracted_by_pdfplumber/*.txt

  (2) pypdf
      - src/bridge_agentic_generate/rag/extract_pdfs_with_pypdf.py
      - 軽量で高速
      - 出力: data/extracted_by_pypdf/*.txt

  (3) pymupdf4llm
      - src/bridge_agentic_generate/rag/extract_pdfs_with_pymupdf4llm.py
      - Markdown 形式での出力に対応
      - 出力: data/extracted_by_pymupdf4llm/*.md

テキスト抽出時にはページ境界を [Page X] マーカーで記録し、後のチャンク化時に
ページ番号を保持できるようにしている。


【チャンク化とインデックス構築】

チャンク化処理（src/bridge_agentic_generate/rag/loader.py）：

  - 入力：抽出済みテキストファイル（.txt）
  - 処理：
    1. [Page X] マーカーでページごとに分割
    2. 各ページテキストを最大 800 文字ごとに分割
    3. 各チャンクに UUID、ソースファイル名、ページ番号を付与
  - 出力：IndexChunk オブジェクトのリスト

インデックス構築処理：

  - 埋め込みモデル: text-embedding-3-small（OpenAI）
  - 埋め込み次元: 1536
  - 出力ファイル：
    - rag_index/pdfplumber/meta.jsonl（チャンクメタデータ）
    - rag_index/pdfplumber/embeddings.npy（埋め込みベクトル行列）

IndexChunk スキーマ：

  {
    "id": "UUID文字列",
    "source": "元PDFファイル名",
    "section": "章名（現状は空）",
    "page": ページ番号（0始まり）,
    "text": "チャンクテキスト本文"
  }


【ベクトル検索機能】

検索処理（src/bridge_agentic_generate/rag/search.py）：

search_text() 関数による検索：

  入力：
    - query: 検索クエリ文字列
    - client: OpenAI クライアント
    - top_k: 返却する上位件数（デフォルト 5）

  処理：
    1. クエリをtext-embedding-3-small で埋め込みベクトル化
    2. 保存済み埋め込み行列とのコサイン類似度を計算
    3. 上位 top_k 件を抽出

  出力：
    - list[SearchResult]: チャンクとスコアのペアのリスト

検索結果スキーマ：

  SearchResult:
    - chunk: IndexChunk（マッチしたチャンク）
    - score: float（コサイン類似度スコア、0.0 ～ 1.0）


--------------------------------------------------------------------------------
4.3 Designer（設計生成）サブシステム
--------------------------------------------------------------------------------

【概要】

Designer サブシステムは、橋長と幅員を入力として受け取り、RAG で取得した
参考文献を基に LLM（GPT-5-mini / GPT-5.1）を用いて鋼プレートガーダー橋の
断面設計を自動生成する。

主な特徴：
  - Structured Output による型安全な設計データ生成
  - マルチクエリ RAG による多面的な参考文献検索
  - 設計ルール（DesignRule）の明示的抽出
  - 設計根拠（reasoning）の記録


【入力仕様】

DesignerInput スキーマ：

  class DesignerInput(BaseModel):
      bridge_length_m: float  # 橋長 L [m]
      total_width_m: float    # 幅員 B [m]

入力パラメータは最小限の 2 つのみとし、その他の設計パラメータ（主桁本数、
桁高、板厚など）は LLM が RAG コンテキストを参照して自動決定する。


【出力仕様（BridgeDesign スキーマ）】

BridgeDesign 構造：

  BridgeDesign
  ├── dimensions: Dimensions          # 全体寸法
  │   ├── bridge_length: float        # 橋長 [mm]
  │   ├── total_width: float          # 全幅 [mm]
  │   ├── num_girders: int            # 主桁本数
  │   ├── girder_spacing: float       # 主桁間隔 [mm]
  │   ├── panel_length: float         # パネル長 [mm]
  │   └── num_panels: int | None      # パネル数（自動計算可）
  │
  ├── sections: Sections              # 断面情報
  │   ├── girder_standard: GirderSection    # 主桁標準断面
  │   │   ├── web_height: float             # 腹板高さ [mm]
  │   │   ├── web_thickness: float          # 腹板厚 [mm]
  │   │   ├── top_flange_width: float       # 上フランジ幅 [mm]
  │   │   ├── top_flange_thickness: float   # 上フランジ厚 [mm]
  │   │   ├── bottom_flange_width: float    # 下フランジ幅 [mm]
  │   │   └── bottom_flange_thickness: float # 下フランジ厚 [mm]
  │   │
  │   └── crossbeam_standard: CrossbeamSection  # 横桁標準断面
  │       ├── total_height: float               # 桁高 [mm]
  │       ├── web_thickness: float              # 腹板厚 [mm]
  │       ├── flange_width: float               # フランジ幅 [mm]
  │       └── flange_thickness: float           # フランジ厚 [mm]
  │
  └── components: Components          # 構成要素
      └── deck: Deck                  # RC 床版
          └── thickness: float        # 床版厚 [mm]


DesignerOutput 構造（LLM からの直接出力）：

  DesignerOutput
  ├── reasoning: str                  # 設計プロセスの思考・判断根拠
  ├── rules: list[DesignRule]         # 適用した設計ルール一覧
  └── bridge_design: BridgeDesign     # 生成された設計


DesignRule 構造：

  DesignRule
  ├── rule_id: str                    # ルールID（"R1", "R2" など）
  ├── category: DesignRuleCategory    # カテゴリ（dimensions/girder_section/deck/crossbeam_section/other）
  ├── summary: str                    # ルール内容の日本語要約
  ├── condition_expression: str | None # 条件式（"web_height ≒ L/20〜L/25" など）
  ├── formula_latex: str | None       # 数式の LaTeX 表現
  ├── applies_to_fields: list[str]    # 影響するフィールド名
  ├── source_hit_ranks: list[int]     # 根拠となる RAG ヒットの rank
  └── notes: str | None               # 補足・注意事項


【マルチクエリ RAG 連携】

Designer は設計生成時に、以下の 5 種類のクエリで RAG 検索を実行する：

  (1) 寸法関連（dimensions）
      クエリ: "鋼プレートガーダー橋 橋長{L}m 幅員{B}m 桁配置 主桁本数 桁間隔 パネル長"

  (2) 主桁配置（girder_layout）
      クエリ: "並列I桁 主桁間隔 幅員と主桁本数の関係 標準断面 主桁本数"

  (3) 主桁断面（girder_section）
      クエリ: "プレートガーダー橋 橋長{L}m 主桁断面 桁高 腹板厚さ フランジ幅 フランジ厚さ 経済的桁高 h/L"

  (4) RC 床版（deck）
      クエリ: "RC床版合成桁 床版厚さ 最小床版厚 床版厚と支間の比"

  (5) 横桁（crossbeam）
      クエリ: "横桁 対傾構 横構 設計"

各クエリで top_k 件（デフォルト 5 件）を取得し、合計最大 25 チャンクの
参考文献をプロンプトに含める。


【プロンプトエンジニアリング】

Designer プロンプトの主要構成：

  (1) ロール設定
      「あなたは鋼橋設計の専門家です。」

  (2) 入力条件
      橋長 L、幅員 B、橋種（鋼プレートガーダー橋 RC床版合成桁）

  (3) 参考文献（RAG Context）
      - [1] 桁配置・支間割・全体諸元
      - [2] 主桁配置（桁本数・主桁間隔）
      - [3] 主桁断面
      - [4] RC床版
      - [5] 横桁・床桁
      - [6] その他

  (4) 設計手順と注意事項
      - 思考プロセスの記述（reasoning）
      - 設計ルールの抽出（rules）
      - 断面諸元の決定（bridge_design）

  (5) 重要な制約
      - 幾何学的整合性（全幅 = (主桁本数-1)×桁間隔 + 2×張出し長）
      - 主桁本数の候補比較（3〜6本）
      - パネル長の整数割り当て
      - すべての寸法は mm 単位


【設計ルール抽出機能】

Designer は設計値だけでなく、適用した設計ルールを明示的に抽出する。

DesignRuleCategory：

  - dimensions: 橋長・幅員・桁本数・桁間隔・パネル長など全体寸法
  - girder_section: 主桁断面
  - deck: RC床版
  - crossbeam_section: 横桁
  - other: その他

source_hit_ranks の取り扱い：

  - RAG ヒットに根拠がある場合：該当する rank 番号をリストで記載
  - 根拠が曖昧/見当たらない場合：source_hit_ranks: [] とし、
    notes に「仮定」「実務目安」等を明記


--------------------------------------------------------------------------------
4.4 Judge（照査・修正提案）サブシステム
--------------------------------------------------------------------------------

【概要】

Judge サブシステムは、Designer が生成した BridgeDesign に対して決定論的な
照査計算を行い、不合格時には LLM を用いて修正提案（PatchPlan）を生成する。

主な特徴：
  - 照査計算は数式ベースの決定論的処理（LLM を使わない）
  - 修正提案のみ LLM が生成するハイブリッドアプローチ
  - 許可されたアクションの範囲内で修正を提案（安全性確保）
  - 修正ループにより合格するまで自動で繰り返し


【荷重計算】

活荷重計算（L荷重・p1/p2ルール）：

道路橋示方書のB活荷重に基づくL荷重計算を内部で自動実行する。

  定数:
    - P1_M = 10.0 kN/m²（曲げ照査用 p1 面圧）
    - P1_V = 12.0 kN/m²（せん断照査用 p1 面圧）
    - P2   = 3.5 kN/m² （p2 面圧、支間80m以下）
    - 主載荷幅 = 5.5 m
    - 載荷長上限 = 10.0 m
    - 適用限界支間長 = 80.0 m

  計算フロー:
    1. 載荷長 D = min(10.0, L)
    2. 等価係数 γ = D(2L - D) / L²
    3. 等価面圧 p_eq = P2 + P1 × γ
    4. 張り出し幅 = (全幅 - (桁本数-1)×桁間隔) / 2
    5. 受け持ち幅 b_i（端桁: 張り出し + 桁間隔/2、中間桁: 桁間隔）
    6. 実効幅 b_eff = 0.5×b_i + 0.5×min(b_i, 5.5)
    7. 等価線荷重 w = p_eq × b_eff
    8. 断面力（単純桁）M = wL²/8, V = wL/2

死荷重計算（桁別計算）：

死荷重は各主桁の受け持ち幅に応じて個別に計算される。

  計算式:
    - 床版自重: w_deck = γ_c × t_deck × b_i
    - 鋼桁自重: w_steel = γ_s × A_girder
    - 死荷重線荷重: w_dead = w_deck + w_steel
    - 断面力: M_dead = w_dead × L² / 8, V_dead = w_dead × L / 2

  ※ 端桁と中間桁で受け持ち幅が異なるため、断面力も異なる
  ※ 曲げとせん断で最厳しい主桁が異なる場合がある


【照査項目】

Judge は以下の 6 項目について照査を実行する：

1. 曲げ応力度照査
  計算式：σ = M_total × y / I
  判定：σ_actual / σ_allow ≤ 1.0（上下フランジ別に評価）
  許容応力度：σ_allow = α_bend × fy（α_bend = 0.6）

2. せん断応力度照査
  計算式：τ_avg = V_total / (t_web × h_web)
  判定：τ_avg / τ_allow ≤ 1.0
  許容応力度：τ_allow = α_shear × (fy / √3)（α_shear = 0.6）

3. たわみ照査
  計算式：δ = 5 × w_eq_live × L⁴ / (384 × E × I)
  判定：δ_actual / δ_allow ≤ 1.0
  許容たわみ：道示準拠（支間長により L/2000 ～ L/500）

4. 床版厚照査
  要求床版厚：d_required = 30 × L_support + 110 [mm]
  （L_support は主桁中心間隔 [m]）
  判定：deck.thickness ≥ d_required

5. 腹板幅厚比照査
  要求腹板厚：web_thickness_min = web_height / 130（SM490 の場合）
  判定：web_thickness ≥ web_thickness_min

6. 横桁配置照査
  判定：panel_length × num_panels ≈ bridge_length（許容誤差 0.1%）


【入出力仕様】

JudgeInput（入力）：

  JudgeInput:
    - bridge_design: BridgeDesign（設計データ）
    - materials_steel: MaterialsSteel（ヤング率、鋼種、単位重量）
    - materials_concrete: MaterialsConcrete（単位重量）
    - judge_params: JudgeParams（α_bend = 0.6、α_shear = 0.6）

  ※ 活荷重は L荷重（p1/p2ルール）に基づいて内部計算される

JudgeReport（出力）：

  JudgeReport:
    - pass_fail: bool（照査合否）
    - utilization: Utilization
        - deck: float（床版厚 util）
        - bend: float（曲げ応力度 util、上下フランジの max）
        - shear: float（せん断応力度 util）
        - deflection: float（たわみ util）
        - web_slenderness: float（腹板幅厚比 util）
        - max_util: float（最大 util）
        - governing_check: GoverningCheck（支配項目）
    - diagnostics: Diagnostics
        - M_total, V_total: 断面力 [N·mm, N]
        - sigma_top, sigma_bottom: 曲げ応力度 [N/mm²]
        - tau_avg: せん断応力度 [N/mm²]
        - delta, delta_allow: たわみ/許容値 [mm]
        - load_effects: LoadEffectsResult（桁別荷重計算結果）
        - governing_girder_index_bend/shear: 最厳しい主桁のインデックス
    - patch_plan: PatchPlan（不合格時の修正提案）
    - evaluated_candidates: list[EvaluatedCandidate]（評価済み修正候補）


【PatchPlan 生成】

不合格時に LLM が生成する修正提案。複数候補方式を採用し、最良案を自動選択。

許可アクション（ALLOWED_ACTIONS）：

  - increase_web_height: 腹板高さを増加（Δ: +100, +200, +300, +500 mm）
  - increase_web_thickness: 腹板厚を増加（Δ: +2, +4, +6 mm）
  - increase_top_flange_thickness: 上フランジ厚を増加
  - increase_top_flange_width: 上フランジ幅を増加
  - increase_bottom_flange_thickness: 下フランジ厚を増加
  - increase_bottom_flange_width: 下フランジ幅を増加
  - set_deck_thickness_to_required: 床版厚を要求値に設定
  - fix_crossbeam_layout: num_panels または panel_length を修正

複数候補方式の処理フロー：

  1. LLM が 3 案を生成（異なるアプローチ: 桁高重視、フランジ厚重視など）
  2. 各案を仮適用・評価（judge_v1_lightweight で max_util をシミュレーション）
  3. improvement（= 現在の max_util - シミュレーション後 max_util）が最大の案を選択

PatchPlan 構造：

  PatchPlanCandidate:
    - plan: PatchPlan（修正計画）
    - approach_summary: str（例: "桁高増でたわみ改善狙い"）

  PatchPlan:
    - actions: list[PatchAction]

  PatchAction:
    - op: PatchActionOp（許可アクション名）
    - path: str（例: "sections.girder_standard.web_height"）
    - delta_mm: float（変更量 [mm]）
    - reason: str（理由）


【Designer-Judge 修正ループ】

run_with_repair_loop() の処理フロー：

  1. 初期設計生成（Designer）
  2. 照査実行（Judge v1）
  3. pass_fail == True → 収束・終了
  4. PatchPlan を BridgeDesign に適用（apply_patch_plan）
  5. 依存関係ルール適用（apply_dependency_rules）
     例：主桁腹板高さ変更時に横桁高さを連動
  6. 次イテレーションへ（Step 2 に戻る）
  7. max_iterations 到達後も不合格 → converged=False で終了

出力（RepairLoopResult）：

  RepairLoopResult:
    - converged: bool（収束したか）
    - num_iterations: int（実行イテレーション数）
    - iterations: list[RepairIteration]（各イテレーションの設計・レポート）
    - final_design: BridgeDesign（最終設計）
    - final_report: JudgeReport（最終照査結果）
    - initial_rag_log: DesignerRagLog（初期設計時の RAG ログ）

修正ループレポート：

各イテレーションの設計・照査結果を Markdown 形式で保存：
  - 保存先：data/generated_report_md/
  - 内容：各イテレーションの util 値、PatchPlan、設計変更履歴


--------------------------------------------------------------------------------
4.5 IFC 変換サブシステム
--------------------------------------------------------------------------------

【概要】

IFC 変換サブシステムは、Designer（または Judge 修正後）の BridgeDesign JSON を
IFC（Industry Foundation Classes）形式に変換し、BIM/CIM ソフトウェアで
利用可能な 3D モデルを出力する。

変換は 2 段階で行われる（推奨パイプライン）：
  (1) BridgeDesign JSON → Senkei JSON（中間形式）
  (2) Senkei JSON → IFC ファイル


【BridgeDesign から Senkei JSON への変換】

変換処理（convert_simple_to_senkei_json.py）：

BridgeDesign から Senkei JSON への変換では、以下の座標計算を行う：

  (1) 主桁配置の X 座標計算
      - 主桁の総スパン: (num_girders - 1) × girder_spacing
      - X オフセット: (total_width - 総スパン) / 2
      - 各主桁の X 座標: x_offset + i × girder_spacing

  (2) パネル分割の Y 座標計算
      - Y 座標リスト: [0, panel_length, 2×panel_length, ..., bridge_length]

  (3) 横桁の配置計算
      - 横桁本数: num_panels - 1（端部を除く）
      - 縦方向ピッチ: panel_length
      - 初期位置: panel_length


Senkei JSON スキーマ（senkei_models.py）：

Senkei JSON は IFC 生成に必要な詳細ジオメトリ情報を持つ中間形式：

  SenkeiJson
  ├── bridge_type: str                    # "Steel Girder"
  ├── geometry: Geometry
  │   ├── girders: GirdersGeometry
  │   │   ├── num_girders: int
  │   │   ├── spacing_x: float            # 主桁間隔 [mm]
  │   │   ├── length: float               # 主桁長さ [mm]
  │   │   ├── x_offset: float             # 主桁開始位置 X [mm]
  │   │   ├── web_height, web_thickness
  │   │   ├── top_flange_width, top_flange_thickness
  │   │   └── bottom_flange_width, bottom_flange_thickness
  │   ├── deck: DeckGeometry
  │   │   ├── length, width, thickness
  │   │   └── points: list[list[float]]   # 床版輪郭座標
  │   └── partition: Partition
  │       ├── x_positions: list[float]
  │       └── y_positions: list[float]
  └── crossbeams: Crossbeams
      ├── use_crossbeams: bool
      ├── num_cross_girders: int
      ├── spacing_z, initial_position_z
      ├── height, flange_width, flange_thickness
      ├── web_thickness
      └── length: float


【Senkei JSON から IFC への変換】

IFC 生成処理（convert_senkei_json_to_ifc.py）：

ifcopenshell ライブラリを使用して IFC ファイルを生成する。

主な処理：

  (1) IFC コンテキストのセットアップ
      - プロジェクト、サイト、建物、スパンの階層構造を作成
      - 幾何コンテキスト（3D Body）を設定

  (2) 床版の生成（Brep）
      - 2D ポリゴンを押し出して直方体を生成
      - Brep ソリッドを作成

  (3) 主桁の生成（SweptSolid）
      - I 形断面プロファイルを定義
      - 断面をパネルごとに押し出し
      - 位置・方向を設定

  (4) 横桁の生成（SweptSolid）
      - I 形断面プロファイルを定義
      - 各主桁間に配置


【生成される IFC 要素】

IFC エンティティ：

  - IfcProject: プロジェクト情報
  - IfcSite: 敷地情報
  - IfcBuilding: 建物（橋梁）情報
  - IfcBridgePartTypeEnum.SPAN: 橋梁スパン
  - IfcBeam: 構造部材（床版、主桁、横桁）

形状表現：

  - Brep: 床版（境界表現による直方体）
  - SweptSolid: 主桁・横桁（断面押し出し）

命名規則：

  - 床版: "Deck"
  - 主桁: "Girder_{桁番号}_Seg_{セグメント番号}"
  - 横桁: "Crossbeam_Row{行番号}_Gap{間隔番号}"

IFC ファイルの活用：

生成された IFC ファイルは以下のソフトウェアで表示・活用可能：

  - BIM ビューア: BIMvision, xBIM, Solibri
  - CAD: Autodesk Revit, ARCHICAD
  - CIM: InfraWorks, Civil 3D
  - オープンソース: FreeCAD, BlenderBIM

3D モデルの座標系：

  - X 軸: 橋軸直角方向（幅員方向）
  - Y 軸: 橋軸方向（橋長方向）
  - Z 軸: 鉛直方向（上向き正）
  - 原点: 床版左下角（X=0, Y=0, Z=床版上面=0）
  - 主桁・横桁は床版下面より下に配置


================================================================================
5. 評価実験（Evaluation）
================================================================================

--------------------------------------------------------------------------------
5.1 実験設定
--------------------------------------------------------------------------------

（後で記載）


--------------------------------------------------------------------------------
5.2 評価指標
--------------------------------------------------------------------------------

（後で記載）


--------------------------------------------------------------------------------
5.3 結果
--------------------------------------------------------------------------------

（後で記載）


================================================================================
6. 考察（Discussion）
================================================================================

（後で記載）


================================================================================
7. おわりに（Conclusion）
================================================================================

（後で記載）


================================================================================
付録 A: 主要 Pydantic モデル一覧
================================================================================

【Designer 関連】

  - DesignerInput: 入力パラメータ（橋長、幅員）
  - BridgeDesign: 設計結果のトップレベルモデル
  - Dimensions: 全体寸法
  - GirderSection: 主桁断面（I形）
  - CrossbeamSection: 横桁断面（I形）
  - Deck: 床版
  - Sections: 断面情報コンテナ
  - Components: 構成要素コンテナ
  - DesignerOutput: LLM からの Structured Output
  - DesignRule: 設計ルール
  - DependencyRule: 依存関係ルール（横桁高さ連動など）
  - DesignerRagLog: RAG 実行ログ
  - RagHit: RAG ヒット 1 件分
  - DesignResult: 設計結果 + RAG ログ + 依存関係ルール

【Judge 関連】

  - JudgeInput: 照査入力（設計、荷重、材料、パラメータ）
  - JudgeReport: 照査結果（合否、utilization、diagnostics、patch_plan）
  - Utilization: 各照査項目の util 値
  - Diagnostics: 中間計算値（20+ 項目）
  - PatchPlan: 修正提案（最大 3 アクション）
  - PatchAction: 修正アクション（action_name、delta、reason）
  - RepairIteration: 修正ループの 1 イテレーション
  - RepairLoopResult: 修正ループ全体の結果
  - SteelGrade: 鋼種（SM400/SM490）
  - GoverningCheck: 支配照査項目（StrEnum）

【IFC 変換関連】

  - SenkeiJson: IFC 生成用中間スキーマ（推奨）
  - Geometry: ジオメトリ情報コンテナ
  - GirdersGeometry: 主桁ジオメトリ
  - DeckGeometry: 床版ジオメトリ
  - Partition: 格間定義
  - Crossbeams: 横桁情報

【RAG 関連】

  - IndexChunk: チャンクメタデータ
  - SearchResult: 検索結果
  - RagIndex: 検索インデックス
  - EmbeddingConfig: 埋め込み設定


================================================================================
付録 B: 設計ルールカテゴリ
================================================================================

DesignRuleCategory（StrEnum）:

  - dimensions: 橋長・幅員・桁本数・桁間隔・パネル長など全体寸法
  - girder_section: 主桁断面（腹板高さ、板厚、フランジ寸法）
  - deck: RC床版（厚さ）
  - crossbeam_section: 横桁（桁高、板厚、フランジ寸法）
  - other: その他


================================================================================
付録 C: 対応 LLM モデル
================================================================================

LlmModel（StrEnum）:

  - GPT_5_MINI = "gpt-5-mini"
    - 高速・低コスト
    - 概略設計には十分な精度
    - デフォルト設定

  - GPT_5_1 = "gpt-5.1"
    - 高精度
    - 複雑な設計条件に対応


================================================================================
付録 D: 参考文献（RAG 対象 PDF）
================================================================================

FileNamesUsedForRag:

  1. 鋼橋設計の基本_第一章 概論.pdf
  2. 鋼橋設計の基本_第四章 鋼橋の設計法.pdf
  3. 鋼橋設計の基本_第六章 床版.pdf
  4. 鋼橋設計の基本_第七章 プレートガーダー橋.pdf
  5. 道路橋示方書_鋼橋・鋼部材編.pdf


================================================================================
文書情報
================================================================================

作成日: 2026年1月26日
バージョン: 1.0（論文用初版）
ステータス: 執筆中

================================================================================
